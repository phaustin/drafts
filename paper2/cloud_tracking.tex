%% Copernicus Publications Manuscript Preparation Template for LaTeX Submissions
%% ---------------------------------
%% This template should be used for the following class files: copernicus.cls, copernicus2.cls, copernicus_discussions.cls
%% The class files, the Copernicus LaTeX Manual with detailed explanations regarding the comments
%% and some style files are bundled in the Copernicus Latex Package which can be downloaded from the different journal webpages.
%% For further assistance please contact the Publication Production Office (production@copernicus.org).
%% http://publications.copernicus.org


%% Differing comments regarding the specific class files are highlighted.


%% copernicus.cls
\documentclass[acp]{copernicus}

%% copernicus2.cls
%\documentclass[acp]{copernicus2}

%% copernicus_discussions.cls
%\documentclass[journal abbreviation, hvmath, online]{copernicus_discussions}


\begin{document}


\title{Statistical analysis of a LES shallow cumulus cloud ensemble using a 
cloud tracking algorithm}


\author[1]{Jordan T Dawe}
\author[1]{Philip H Austin}

\affil[1]{Department of Earth and Ocean Sciences, 
        University of British Columbia, 
	6339 Stores Road, 
        Vancouver, BC, 
        V6T 1Z4}

%% The [] brackets identify the author to the corresponding affiliation, 1, 2, 3, etc. should be inserted.



\runningtitle{CLOUD TRACKING}

\runningauthor{Dawe and Austin}

\correspondence{Jordan T Dawe\\ (jdawe@eos.ubc.ca)}



\received{}
\pubdiscuss{} %% only important for two-stage journals
\revised{}
\accepted{}
\published{}

%% These dates will be inserted by the Publication Production Office during the typesetting process.


\firstpage{1}

\maketitle



\begin{abstract}
A technique for the tracking of individual clouds in an large eddy 
simulation model is presented.  We use this technique on a LES of a 
shallow cumulus cloud field based upon the Barbados Oceanographic and 
Meteorological Experiment (BOMEX), to calculate statistics of cloud 
height, lifetime, and other physical properies for individual clouds 
in the model.  We also examine the question of nature versus nurture 
in shallow cumulus cloud fields: do properties at cloud base determine 
the upper-level properties of the clouds (nature), or are cloud properties 
determined by the environmental conditions they encounter (nurture).  
We find that clouds which ascend through an environment that has been 
pre-moistened by previous cloud activity are no more likely to reach 
the inversion than clouds that ascend through a drier environment.  
Conversely, we find that cloud base moisture and liquid-water potential 
temperature are largely uncorrelated with upper-level cloud properties, 
but that the area of the cloud base exerts strong controls over cloud 
buoyancy, vertical velocity, and maximum cloud height.  We conclude 
that cloud properties are primarily controlled by cloud base area, and thus
nature is more important than nurture for shallow cumulus clouds.
\end{abstract}


%% only used for copernicus2.clsu
%\abstract{
% TEXT
% \keywords{TEXT}}



\introduction
%% \introduction[modified heading if necessary]

- Clouds are vital for climate
- hard to parameterize
- Studied via LES
- LES studies traditionally look at bulk cloud properties

- Individual plumes
- Arakawa and Shubert
- Zhao and Austin (
- Heus and Jonkers

- Satellite cloud tracking/cloud identification.

- Better would be an automated system

Here we present a fully automated algorithm for the tracking of individual 
clouds in a LES.  In section 2 we describe the BOMEX LES we analyzed, section 
3 presents the cloud tracking algorithm itself, and section 4 presents an 
overview of the statistics generated by the algorithm.  Then in section 5 we 
use the output generated by the algorithm to address the question of whether 
initial cloud properties or the environment encountered by the cloud is more 
important in determining the course of the cloud's life cycle.  Finally in 
section 6 we discuss our results and conclusions.

%==============================================================================

\section{Model Description}

All LES calculations in this paper were made using the System for Atmospheric 
Modeling \citep[SAM;][]{Khairoutdinov2003}.  SAM is an anelastic LES 

The model was run configured as standard Global Energy and Water
Cycle Experiment (GEWEX) Cloud System Studies \citep[GCSS;][]{Randall2003}
Barbados Oceanographic and Meteorological Experiment 
\citep[BOMEX;][]{Siebesma2003} experiment.  BOMEX simulates a trade-wind 
cumulus cloud field observed over ocean near Bermuda

The BOMEX run was performed on a 6.4 km x 6.4 km horizontal x 3.2 km vertical 
domain with 25 meter grid resolution in all directions for 6 hours, and the 
first three hours of simulation were discarded.  Model fields were output 
every minute for the last three hours of the simulation, and th

%==============================================================================

\section{Cloud Tracking}

Dividing a cloud field up into individual clouds at a single moment in time is 
a trivial matter of finding connected cloudy regions.  Tracking the resulting 
clouds from one time step to the next is more problematic, as a cloud is a 
process, not a consistent physical object.  A rising parcel of moist air 
may condense, a parcel of air containing condensate may evaporate, and a cloud 
may merge with another cloud or split into multiple clouds.  To handle all of 
these possible events, we adopt a more complex definition of what constitutes 
a cloud.

\subsection{Cloud Tracking Algorithm}

We begin by defining three cloud regions (Fig. \ref{fig:vertical_section}).  
The first is the cloud ``core", defined following \cite{Siebesma1995} as all 
model points containing condensed liquid water which have positive buoyancy and 
upward velocity.  The second we refer to as the ``condensed" region, defined 
simply as all model points containing condensed liquid water.  Third is the 
cloud ``plume", the region of upward moving air that is associated with the 
cloud.  We define this region following the work of \cite{Couvreaux2010} via a 
numerical tracer that is emitted at the surface and subsequently decays 
exponentially with a one minute time constant.  A point is considered to be in 
the plume if the tracer value of that point is larger than one standard 
deviation above the mean tracer value at the current height.  Additionally, 
the tracer must exceed five precent of the integral of the tracer standard 
deviation from the surface to the current height.  However, unlike 
\citeauthor{Couvreaux2010}, we do not require upper-level plume points to have 
condensed liquid water.  Finally, we force the condensed region to be a subset 
of the plume by setting all condensed points to also be plume points.

Next, we divide the cloud field into ``cloudlets" by assigning core points 
which are nearest-neighbour adjacent to the same cloudlet.  These core 
cloudlets are then expanded into nearest-neighbour connected condensed points 
until all condensed points that are connected to a core are assigned to a 
cloudlet.  Condensed points cannot belong to two cloudlets, so if a cloud 
contains more than one contiguous volume of nearest-neighbour connected core 
points it will be split into seperate cloudlets.  Leftover condensed points are 
then divided into new cloudlets which have no cores.  Once all the condensed 
points have been assigned to cloudlets, this expansion process is repeated for 
the plume points.  This results in three types of cloudlets: ones consisting of 
core points surrounded by condensed points surrounded by plume, ones consisting 
of condensed points surrounded by plume, and ones consisting only of plume 
points.  This process is then repeated for every saved model time step.

These cloudlets are then assigned to individual clouds.  For the first time 
step, we assign cloudlets which have touching condensed surfaces to the same 
cloud.  At subsequent time steps, cloudlets that spatially overlap with a cloud 
at the previous timestep are assumed to be the same cloud.  The cloudlet's 
position is corrected for advection using the mean velocity of the cloudlet's 
condensed points (if condensed points are present in the cloudlet) or plume 
(if they are not), multiplied by the time between model output saves.

Four kinds of overlap are possible: condensed points in the cloudlet may 
overlap condensed points in a previous time step cloud 
(condensed$\rightarrow$condensed); condensed points may overlap previous plume 
points (plume$\rightarrow$condensed); plume may overlap condensed points 
(condensed$\rightarrow$plume); and plume may overlap plume 
(plume$\rightarrow$plume).  Several kinds of overlap may occur simultaneously, 
so we define a heirarchy of connection types and check each in turn.  The 
strongest connection type is condensed$\rightarrow$condensed, followed by 
plume$\rightarrow$condensed, then plume$\rightarrow$plume.  
Condensed$\rightarrow$plume connections are ignored, which prevents 
connections between newly formed cloudlets and leftover plume from a 
dissipating cloud.  Conversely, allowing plume$\rightarrow$condensed 
connections lets us associate newly condensed clouds with plumes rising through 
the sub-cloud layer.  Only the strongest connection type present for a given 
cloudlet is considered: if a cloudlet has condensed$\rightarrow$condensed 
connections, any condensed$\rightarrow$plume or plume$\rightarrow$plume 
connections are ignored, and if there are condensed$\rightarrow$plume 
connections, plume$\rightarrow$plume connections are ignored.  

A cloudlet may connect to more than one cloud, which is used to identify 
merges and splits (Fig. \ref{fig:cloudfinder_instructions}).  Any cloudlet 
which overlaps more than one previous time step cloud is considered to be the 
result of a merge between the two clouds.  In this case the cloudlet is 
assigned to the cloud with the largest overlap, and the other overlapping 
clouds are assumed to have merged with the largest overlap cloud.  Next, 
clouds that connect to more than one cloudlet are considered for splitting.  
Splits occur only if a cloud contains more than one cloudlet whose plume is in 
contact with the ground, with the largest cloudlet being assigned to the 
original cloud and the smaller sub-clouds becoming new clouds. Cloudlets which 
are not connected to the ground are assigned to the nearest ground-connected 
cloudlet, measured by the distance between the centroids of the cloudlets.  
Any cloudlets that do not overlap clouds in the previous time step are assumed 
to be new clouds.  This process of cloudlet assignment, merging, splitting, and 
creation is repeated for each time step until all cloudlets are assigned to a 
cloud.
  
Once the cloudlets are all assigned to a cloud, any cloud that has condensed 
points for less than five minutes is flagged.  If any merge or split events 
occured over these clouds' short lifetimes, the cloud is rejoined to the cloud 
it split from or merged into.  This prevents decaying detritus shed from a 
cloud top and clouds which split then immediately re-merge with their parent 
from being counted as discrete cloud objects.  Finally, clouds that have 
condensed liquid water for less than two minutes, and thus are unconnected to 
future or past clouds, are placed into a ``cloud noise" group consisting of a 
mixture of ``mistakes" in the tracking algorithm and short-lived, dynamically 
forced clouds at cloud base. 

\subsection{Cloud Tracking Results}

Applying the cloud tracking algorithm to three hours of BOMEX LES output 
resulted in 1,480 tracked clouds.  Of these, 539 (36\%) were created by 
splitting an existing cloud, 877 (59\%) were unassosciated with previous 
clouds, and 64 (4.3\%) were present at the start of the data period and thus 
their initiation was not observed.  91 (6.1\%) of these clouds went on to merge 
with another cloud, 1333 (90\%) ended their lifecycle by decaying away, and 
56 (3.8\%) were present at the end of the data period.

Figure \ref{fig:example_cloud} displays horizontally averaged cloud properties 
for the longest-lived cloud in the ensemble.  The cloud's cross-sectional area 
shows two large discontinuities in time due to a merge event with another large 
cloud (at 46 minutes) and a split event which nearly divides the cloud in two 
(at 54 minutes).  However, most of the merge and split events that occur to
this cloud do not significantly alter the cloud area and none of the other 
horizontally averaged properties display significant discontinuities.  Most of 
the cloud maintains upward velocities over 0.5 m s$^{-1}$ (fig. 
\ref{fig:example_cloud}b), though short-lived downdrafts are apprent in the 
inversion (above $\approx$ 1.5 km).  Total Specific Water ($q_t$, units of 
g kg$^{-1}$, fig. \ref{fig:example_cloud}c), Liquid-Water Potential 
Temperature ($\theta_l$, units of K, fig. \ref{fig:example_cloud}d), and 
condensed liquid water ($q_l$, units of g kg$^{-1}$, fig. 
\ref{fig:example_cloud}e) are similar to the environmental properties near 
cloudbase but the $q_t$ excess, $\theta_l$ deficit, and $q_l$ of the cloud 
increases with height and indications of upward propagating pulses can be seen 
in these fields.  The cloud buoyancy is generally positive below 1 km, and some 
strong pulses bring positive buoyancy up to a height of 1.3 km 
(displayed using virtual potential temperature $\theta_v$, units of K, fig. 
\ref{fig:example_cloud}f).

Core properties (with cloud core defined as cloud points having upward velocity
and positive buoyancy) for the same cloud \ref{fig:example_core} display 
buoyant mass pulses much more clearly than the cloud properties.  Cloud core 
occupies roughly half the horizontal cloud area at any given height.  Cloud 
core vertical velocity increases steadily with height and $q_t$ excess, 
$\theta_l$ deficit, and $q_l$ are all greatest at cloud top.  Core buoyancy 
is positive by definition, but unlike in the cloud, regular buoyant pulses are
apparent.

Comparing this example cloud with the example clouds presented by 
\citet[][figs. 4 and 5]{Heus2009} shows that the velocities and buoyancies of 
our cloud are roughly half as large at \citeauthor{Heus2009}.  There are 
several possible reasons for these differences.  First, our example cloud has 
a lifetime is nearly twice as long, and a horizontal extent nearly 15 times 
larger, than the clouds presented by \citeauthor{Heus2009}.

30-40 minutes vs 1 hour
our cloud ~ 15 times larger

\citeauthor{Heus2009} specificially selected clouds that do not interact with other 
clouds.  This is a perfectly understandable choice to make when manually 
selecting clouds, but it results in a sample that is explicitly biased.  Our 
example cloud experiences at least one strong merge and one strong split event.

%==============================================================================

\section{Tracked Cloud Statistics}

(fig \ref{fig:cloud_stats})

Cloud lifetime and maximum cloud height both display distributions consistent 
with a power law scaling for these quantities.  The cloud lifetime distribution 
displays a deficit of clouds with a lifetime shorter than five minutes; this is 
an aftifact of our imposed constraint that tracked clouds have lifetimes longer 
than five minutes.

Average lifespan 11.7 minutes

Only eight clouds have lifespans longer than an hour

*TK* why clouds with lifetime less than five minutes.

over 90\% of clouds have cloud base between 500 and 600 m, with roughly 90

*TK* filter start/end clouds

over 90\% of clouds have a mean area averaged over their lifetime smaller than 
40000 m$^2$ (200 m by 200 m, 8x8 grid cells

All of these are physicaly plausable and indicate the tracking algorithm is not
completely insane

Finally, we compare the cloud size distribution generated by our tracking 
algorithm with similar calculations from LES \cite{TK} and satellite 
observations \cite{TK}.  The tracking algorithm generates a cloud size 
distribution that follows a power law with a TK slope (fig \ref{fig:cloud_areas})

%==============================================================================

\section{Nature versus Nurture}
TEXT

Bonferroni Correction!!!

\subsection{Cloudbase Properties}

\subsection{Cloud Environment}

%==============================================================================

\conclusions
%% \conclusions[modified heading if necessary]
TEXT


%\appendix
%\section{\\ \\ \hspace*{-7mm} HEADING}    %% Appendix A

%\subsection                               %% Appendix A1, A2, etc.

\begin{acknowledgements}
Support for this research was provided by the Canadian Foundation for Climate 
and Atmospheric Science through the Cloud Aerosol Feedback and Climate 
network.  Figures were generated using the matplotlib library in the Python
programming language.
\end{acknowledgements}


\bibliographystyle{copernicus}
\bibliography{./bibliography/cloud_tracking}


%% Literature citations
%% command                        & example result
%% \citet{jones90}|               & Jones et al.\ (1990)
%% \citep{jones90}|               & (Jones et al., 1990)
%% \citep{jones90,jones93}|       & (Jones et al., 1990, 1993)
%% \citep[p.~32]{jones90}|        & (Jones et al., 1990, p.~32)
%% \citep[e.g.,][]{jones90}|      & (e.g., Jones et al., 1990)
%% \citep[e.g.,][p.~32]{jones90}| & (e.g., Jones et al., 1990, p.~32)
%% \citeauthor{jones90}|          & Jones et al.
%% \citeyear{jones90}|            & 1990






%% FIGURES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% ONE-COLUMN FIGURES

%f
%\begin{figure}[t]
%\vspace*{2mm}
%\begin{center}
%\includegraphics[width=8.3cm]{./figures/figure1}
%\end{center}
%\caption{Schematic representation of our cloudlet algorithm.}
%\label{fig:cloudfinder_instructions}
%\end{figure}


%% TWO-COLUMN FIGURES

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/vertical_section}
\end{center}
\caption{Vertical section through the BOMEX model, showing the cloud core
(red), the cloud (yellow) and the plume (blue) regions used by the cloud 
tracking algorithm. Black lines show the edges of ``cloudlets" identified by 
the cloud tracking algorithm.}
\label{fig:vertical_section}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/cloudfinder_instructions}
\end{center}
\caption{Schematic representation of our cloud tracking algorithm.}
\label{fig:cloudfinder_instructions}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/example_cloud}
\end{center}
\caption{Height-time profiles of cloud properties of the longest-lived cloud 
in the BOMEX simulation.}
\label{fig:example_cloud}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/example_core}
\end{center}
\caption{Height-time profiles of core properties of the longest-lived cloud in 
the BOMEX simulation.}
\label{fig:example_core}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/cloud_stats}
\end{center}
\caption{Histograms of cloud lifetimes and heights.}
\label{fig:cloud_stats}
\end{figure*}

%f
\begin{figure}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=8.3cm]{./figures/cloud_areas}
\end{center}
\caption{Cloud size density}
\label{fig:cloud_areas}
\end{figure}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/cloud_environment_schematic}
\end{center}
\caption{Schematic of encountered cloud environment calculation.}
\label{fig:cloud_environment_schematic}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/cloud_environment_histograms}
\end{center}
\caption{Histograms of encountered cloud environment.}
\label{fig:cloud_envionment_histograms}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/cloud_base_schematic}
\end{center}
\caption{Schematic of cloud base correlation calculation.}
\label{fig:cloud_base_schematic}
\end{figure*}

%f
\begin{figure}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=8.3cm]{./figures/sub_cloud_profiles}
\end{center}
\caption{Correlation profiles between sub-cloud properties and various cloud heights.}
\label{fig:sub_cloud_profiles}
\end{figure}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/cloud_base_profiles}
\end{center}
\caption{Correlation profiles between cloud base and various cloud heights.}
\label{fig:cloud_base_profiles}
\end{figure*}

%f
\begin{figure*}[t]
\vspace*{2mm}
\begin{center}
\includegraphics[width=\textwidth]{./figures/750m_profiles}
\end{center}
\caption{Correlation profiles between 750m properties and various cloud heights.}
\label{fig:750m_profiles}
\end{figure*}


%% TABLES %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% ONE-COLUMN TABLE

%t
%\begin{table}[t]
%\label{tbl:cloud_stats}
%\caption{Statistics of tracked clouds}
%\vskip4mm
%\centering
%\begin{tabular}{llcr}
%\tophline
%&&BOMEX\\
%\middlehline
%Total Clouds&&1480\\
%Starts\\
%&Broken&64\\
%&Split&539\\
%&New&877\\
%Ends\\
%&Broken&56\\
%&Merge&91\\
%&Decay&1333\\

%\bottomhline
%\end{tabular}
%\end{table}

%t
%\begin{table}[t]
%\caption{t-test Results}
%\vskip4mm
%\centering
%\begin{tabular}{lcccc}
%\tophline
%&Variable&t-test value&Significance&Direction\\
%\middlehline
%environment&&&\\
%& $q_t$ & -1.33 & 81\% & n/a\\
%& $q_n$ & 0.02 & 2\% & n/a\\
%& tracer & 0.72 & 53\% & n/a\\
%& $\theta_l$ & 2.53 & 98\% & $\downarrow$\\
%& $\theta_v$ & 2.77 & 99.4\% & $\downarrow$\\
%& $w$ & -4.99 & 99.9999\% & $\uparrow$\\
%core&&&\\
%& $q_t$ & 1.57 & 88\% & n/a \\
%& $q_n$ & -0.04 &  3\% & n/a \\
%& $\theta_l$ & -2.10 & 96\% & $\uparrow$ \\
%& $\theta_v$ & -3.55 & 99.96\% & $\uparrow$ \\
% $w$ & -4.21 & 99.997\% & $\uparrow$ \\
%& $\chi_c$ & -5.14 & 99.99995\% & $\uparrow$ \\
%& $a$ & -7.10 & 99.999999992\% & $\uparrow$ \\

%\bottomhline
%\end{tabular}
%\end{table}

%% TWO-COLUMN TABLE

t
\begin{table*}[t]
\label{tbl:t_test}
\caption{t-test results}
\vskip4mm
\centering
\begin{tabular}{lccccc}
\tophline
&&550-750 m&&750-950 m& \\
&Variable&t-test value&Significance&t-test value&Significance\\

\middlehline

environment &&       &             &       &        \\
& $q_t$      & -0.49 & 37\%        &  3.03 & 99.7\% \\
& $q_n$      &  0.02 &  2\%        &  2.21 & 97\%   \\
& tracer     & -1.77 & 92\%        &  1.56 & 88\%   \\ 
& $\theta_l$ & -0.52 & 40\%        & -3.21 & 99.8\% \\
& $\theta_v$ & -1.29 & 80\%        & -2.42 & 98\%   \\
& $w$        &  5.59 & 99.999995\% &  2.91 & 99.6\% \\
core        &&       &                 \\
& $q_t$      & -1.24 & 78\%         & -1.59 & 88\%           \\
& $q_n$      & -0.18 & 14\%         & -0.27 & 21\%           \\
& $\theta_l$ &  1.51 & 86\%         & 1.81 & 92\%            \\
& $\theta_v$ &  2.07 & 96\%         & 2.76 & 99.3\%          \\
& $w$        &  2.68 & 99.2\%       & 0.21 & 17\%            \\
& $\chi_c$   &  5.26 & 99.99997\%   & 4.41 & 99.998\%        \\
& $a$        &  6.61 & 99.9999997\% & 7.46 & 99.9999999997\% \\

\bottomhline
\end{tabular}
\end{table*}

%% The different columns must be seperated with a & command and should
%% end with \\ to identify the column brake.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%% If figures and tables must be numbered 1a, 1b, etc. the following command
%% should be inserted before the begin{} command.

%\addtocounter{figure}{-1}\renewcommand{\thefigure}{\arabic{figure}a}


\end{document}
