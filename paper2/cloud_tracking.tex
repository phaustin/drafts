%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% PREAMBLE
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%
% The following two commands will generate a PDF that follows all the 
% requirements for submission and peer review.  Uncomment these commands to 
% generate this output (and comment out the two lines below.)
%
% DOUBLE SPACE VERSION FOR SUBMISSION TO THE AMS
\documentclass[12pt]{article}
\usepackage{ametsoc}
%
% The following two commands will generate a single space, double column paper 
% that closely matches an AMS journal page.  Uncomment these commands to 
% generate this output (and comment out the two lines above. FOR AUTHOR USE 
% ONLY. PAPERS SUBMITTED IN THIS FORMAT WILL BE RETURNED TO THE AUTHOR for 
% submission with the correct formatting.
%
% TWO COLUMN JOURNAL PAGE LAYOUT FOR AUTHOR USE ONLY
%%%%\documentclass[10pt]{article}
%%%%\usepackage{ametsoc2col}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% ABSTRACT
%
% Enter your Abstract here
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\newcommand{\myabstract}{
A technique for the tracking of individual clouds in an large eddy 
simulation model is presented.
}
%
\begin{document}
%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% TITLE
%
% Enter your TITLE here
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\title{\textbf{\large{Something about cloud tracking}}}
%
% Author names, with corresponding author information. 
% [Update and move the \thanks{...} block as appropriate.]
%
\author{\textsc{Jordan T. Dawe}
	\thanks{\textit{Corresponding author address:} 
	Jordan T. Dawe, 
        Department of Earth and Ocean Sciences, 
        University of British Columbia, 
	6339 Stores Road, 
        Vancouver, BC, 
        V6T 1Z4. 
	\newline{E-mail: jdawe@eos.ubc.ca}}\quad\textsc{and Philip Austin}\\
\textit{\footnotesize{Department of Earth and Ocean Sciences, 
                      University of British Columbia, Vancouver, BC}}
}
%
% Formatting done here...Authors should skip over this.  See above for abstract.
\ifthenelse{\boolean{dc}}
{
\twocolumn[
\begin{@twocolumnfalse}
\amstitle

% Start Abstract (Enter your Abstract above.  Do not enter any text here)
\begin{center}
\begin{minipage}{13.0cm}
\begin{abstract}
	\myabstract
	\newline
	\begin{center}
		\rule{38mm}{0.2mm}
	\end{center}
\end{abstract}
\end{minipage}
\end{center}
\end{@twocolumnfalse}
]
}
{
\amstitle
\begin{abstract}
\myabstract
\end{abstract}
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% MAIN BODY OF PAPER
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Introduction}

%==============================================================================

\section{Cloud Tracking}

Dividing a cloud field up into individual clouds at a single moment in time is 
a trivial matter: a cloudy point belongs to a given cloud if it is touching 
that cloud.  However, tracking the resulting clouds from one time step to the 
next is much more problematic, as a cloud is not a consistent physical object; 
it is, rather, a series of processes.  A rising parcel of moist air may 
condese, a parcel of air containing condensate may evaporate, and a cloud may 
be split in two by air turbulence or collide with another cloud and merge into 
one.  To be able to handle all of these processes, we adopt a more complex 
definition of what constitutes an individual cloud.

First, we define two cloud regions.  First is the cloud core, defined following 
\cite{Siebesma1995} as all cloudy points which have positive buoyancy and 
upward velocity.  Second is the cloud shell, which we define as all points 
with a specific humidity $q_v$ (kg water vapor per kg dry air) one standard 
deviation higher than the mean humidity at a given height, and a liquid-water
moist static energy $h$ (J kg$^{-1}$) one standard deviation lower than the 
mean $h$ at a given height.  In general, the core region is a subset of the 
shell region.  The purpose of these two regions is to delinate cloud splits 
and merges: if two cloud cores touch, the clouds are considered to have merged, 
and if parts of a cloud seperate such that their shells no longer touch, the 
clouds are considered to have split.  This definition makes clouds slightly 
sticky, and ensures that clouds do not repeatedly split and merge as small 
tendrils are torn from the main cloud mass and evaporate.

next, we identify the distance of all core grid cells from the core surface--
the "depth" into the cloud mass of the grid cell (Figure 1a).  We do 
this by labeling all core grid cells directly adjactent to a non-core grid 
cell with '1'; grid cells diagonally adjacent are ignored.  Then core cells 
adjactent to the cells labelled '1' are labelled '2', and the process is 
repeated until all core grid cells are labelled with their depth.

Next, we divide the field up into "cloudlets", sub-units of the core which are 
centered on points that are far from the core surface, using a process based 
on ideas of crystal growth (Figure 1b).  First, we select one of the deepest 
points in the core and assign it to a cloudlet.  Next, any points at the same 
depth which are touching the cloudlet are absorbed into the cloudlet, until the 
cloudlet is no longer touching unassigned points.  If there are still points at 
the same depth they are not part of the cloudlet; a new point is selected, 
assigned to a new cloudlet, and this process is repeated until all the deepest 
grid cells are assigned to cloudlets.  Then the next-deepest points are 
selected, and each cloudlet is expanded into these points.  Points that 
could be assigned to more than one cloudlet go to the nearest cloudlet, or are 
assigned randomly if two cloudlets are equally distant.  Points that remain 
unassigned are added to new cloudlets in the same manner as the deepest points, 
and the process is repeated until all core points are assigned to a cloudlet.

Once all the core points have been assigned to cloudlets, this process is 
continued for the shell points in the same manner, until the shell points have 
all been assigned to cloudlets as well.  Note that it is possible to have a 
cloudlet that is composed entirely of shell points.  This process is repeated 
for every saved model time step.

Next, any cloudlets which have spatially connected cores in the first time step 
are joined into clouds.  At subsequent time steps, cloudlets that spatially 
overlap with a cloud at the previous timestep are assumed to be the same cloud.
The cloudlet's position is corrected by calculating the cloudlet's mean 
velocity and the distance the cloudlet would have moved over the time step is 
removed.  If a cloudlet overlaps two or more clouds, the cloudlet is assigned 
to the cloud with the greatest spatial overlap.  Any cloudlets that do not 
overlap clouds in the previous time step are assumed to be new clouds.

At this point merges and splits are performed.  Any clouds that have connected 
cores are merged into a single cloud, with the largest cloud engulfing the 
smaller clouds.  Any cloud which contains cloudlets that do not have connected
shells are split into two clouds, with the largest sub-cloud being assigned to 
the original cloud and the smaller sub-clouds becoming new clouds.  Then the 
process of cloudlet assignment, merging, and splitting is repeated with the 
next time step, until all cloudlets are assigned to a cloud.

Once the clouds are all assigned, any cloud that is present for less than 
five minutes is flagged as noise and analyzed seperately from the rest of 
the clouds.

%==============================================================================

\section{Tracked Cloud Statistics}


\begin{equation}
\label{eq:E_minus_D} 
E - D = \int_C \rho ( \mathbf{u} -  \mathbf{u_i}) \cdot d\mathbf{C},
\end{equation}



Consider a numerical model grid cell containing a cloud surface with normal 
vector $\mathbf{C}$, where $\mathbf{C}$ points outward from the surface and 
has units of m$^2$.  This surface, combined with $\mathbf{W}$, the portion of 
the grid cell walls that lie within the cloud in m$^2$, encloses a cloud volume 
$V$ which has units of m$^3$.  \cite{Siebesma1998} gives the net entrainment and 
detrainment over the cloud surface to be:
\begin{equation}
\label{eq:Echi_minus_Dchi} 
E\chi - D\chi = \int_C \rho \chi ( \mathbf{u_i} -  \mathbf{u}) \cdot d\mathbf{C},
\end{equation}
where $\rho$ is the air density in kg m$^{-3}$, $\mathbf{u}$ is the velocity
of the air in m s$^{-1}$ and $\mathbf{u_i}$ is the velocity of the cloud 
interface in m s$^{-1}$.

To calculate the velocity of the cloud surface, we make use of the Leibnitz 
Theorem:
\begin{equation}
\label{eq:leibnitz} 
\frac{d}{dt}\int_{V(t)} \rho \chi dV = 
  \int_{V(t)} \frac{\partial \rho \chi}{ \partial t} dV 
  + \int_{C(t)} \rho \chi \mathbf{u_i}\cdot d\mathbf{C}
  + \int_{W(t)} \rho \chi \mathbf{u_i}\cdot d\mathbf{W}.
\end{equation}
Since the walls of the grid cell do not move, $\mathbf{u_i}$ is 0 over 
$\mathbf{W}$.  If we also assume ${\partial \rho}/{ \partial t} \approx 0$ and 
that $\rho$ is constant over a grid cell, we get
\begin{equation}
\label{eq:leibnitz2} 
    \rho \frac{d}{dt}\int_{V(t)} \chi dV = 
    \rho \int_{V(t)} \frac{\partial \chi}{ \partial t} dV 
    + \int_{C(t)} \rho \chi \mathbf{u_i}\cdot d\mathbf{C}.
\end{equation}
We then combine equations (\ref{eq:Echi_minus_Dchi}) and (\ref{eq:leibnitz2}) to give:
\begin{equation}
\label{eq:step1} 
      E\chi - D\chi = \rho \frac{d}{dt}\int_{V(t)} \chi dV
                    - \rho \int_{V(t)} \frac{\partial \chi}{ \partial t} dV 
                    - \int_C \rho \chi \mathbf{u} \cdot d\mathbf{C}.
\end{equation}

Next we apply the divergence theorem to simplify the flux integral through 
$\mathbf{C}$:
\begin{equation}
\label{eq:divergence} 
\int_{V} \nabla \cdot (\rho \chi \mathbf{u}) dV = 
  \int_{C} \rho \chi \mathbf{u}\cdot d\mathbf{C}
+ \int_{W} \rho \chi \mathbf{u}\cdot d\mathbf{W}
\end{equation}
Substituting this into (\ref{eq:step1}) and assuming that $\chi$ is constant 
over a grid cell results in
\begin{equation}
\label{eq:entrainment_detrainment} 
E\chi - D\chi = \rho \chi \frac{dV}{dt} 
              + \int_W \rho \chi \mathbf{u} \cdot d\mathbf{W} 
              - V \nabla \cdot (\rho \chi \mathbf{u}).
\end{equation}
Finally, if $\chi$ is positive, $E\chi - D\chi$ is divided between $E\chi$ and 
$D\chi$ as follows:  
\begin{equation}
\label{eq:max_ent} 
E\chi = \mathrm{max}\left(0, \rho \chi \frac{dV}{dt} 
                           + \int_W \rho \chi \mathbf{u} \cdot d\mathbf{W} 
                           - V \nabla \cdot (\rho \chi \mathbf{u})\right)
\end{equation}
\begin{equation}
\label{eq:max_det} 
D\chi = \mathrm{max}\left(0, - \rho \chi \frac{dV}{dt} 
                             - \int_W \rho \chi \mathbf{u} \cdot d\mathbf{W}
                             + V \nabla \cdot (\rho \chi \mathbf{u})\right).
\end{equation}
and if $\chi$ is negative, $E\chi - D\chi$ is divided as:
\begin{equation}
\label{eq:max_ent} 
E\chi = \mathrm{min}\left(0, - \rho \chi \frac{dV}{dt} 
                             - \int_W \rho \chi \mathbf{u} \cdot d\mathbf{W} 
                             + V \nabla \cdot (\rho \chi \mathbf{u})\right)
\end{equation}
\begin{equation}
\label{eq:max_det} 
D\chi = \mathrm{min}\left(0, \rho \chi \frac{dV}{dt} 
                           + \int_W \rho \chi \mathbf{u} \cdot d\mathbf{W}
                           - V \nabla \cdot (\rho \chi \mathbf{u})\right).
\end{equation}



\subsection{Cloud Surface Interpolation}

\ref{fig:direct_vs_tracer}).

%==============================================================================

\section{Conclusions}


%==============================================================================


\begin{acknowledgment}
Support for this research was provided by the Canadian Foundation for Climate 
and Atmospheric Science through the Cloud Aerosol Feedback and Climate 
network.  Figures were generated using the matplotlib library in the Python
programming language.
\end{acknowledgment}

% Use appendix}[A], {appendix}[B], etc. etc. in place of appendix 
% if you have multiple appendixes.
%\ifthenelse{\boolean{dc}}
%{}
%{\clearpage}
%\begin{appendix}
%\section*{\begin{center}Appendix Title Is Entered Here (Primary heading)\end{center}}
%\subsection{First appendix secondary heading}

%\subsection{Second appendix secondary heading}

%\subsubsection{First appendix tertiary heading}

%\subsubsection{Second appendix tertiary heading}

%\paragraph{First appendix quaternary heading}

%\paragraph{Second appendix quaternary heading}

%\end{appendix}

% Create a bibliography directory and place your .bib file there.
\ifthenelse{\boolean{dc}}
{}
{\clearpage}
\bibliographystyle{./ametsoc}
\bibliography{./bibliography/cloud_tracking}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% FIGURES
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{figure}[t]
  \noindent\includegraphics[width=40pc,angle=0]{./figures/figure1}\\
  \caption{Schematic representation of our cloudlet algorithm.}\label{fig:figure1}
\end{figure}

\begin{figure}[t]
  \noindent\includegraphics[width=40pc,angle=0]{./figures/figure1}\\
  \caption{Associating cloudlets with cloud from previous time step.}\label{fig:figure1}
\end{figure}


\end{document}
